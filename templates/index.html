<!DOCTYPE html>
<html>
<head>
    <title>Voice ‚Üí Website Generator</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background-color: #f4f4f4;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 900px;
        }

        h2 {
            margin-bottom: 15px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }

        textarea {
            width: 100%;
            height: 120px;
            margin-top: 20px;
            padding: 12px;
            font-size: 14px;
            resize: none;
        }

        /* Mic UI */
        .mic-container {
            margin: 25px 0;
            display: flex;
            justify-content: center;
        }

        .mic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 34px;
            color: #555;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .output-box {
            margin-top: 25px;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
        }

        iframe {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            margin-top: 15px;
        }
    </style>
</head>

<body>
<div class="container">
    <h2>üéôÔ∏è Voice ‚Üí Website Generator</h2>

    <!-- Buttons -->
    <button id="micBtn" onclick="startRecording()">Start Speaking</button>
    <button onclick="generateWebsite()">Generate Website</button>
    <button onclick="downloadHTML()">Download HTML</button>

    <!-- Mic Visual -->
    <div class="mic-container">
        <div id="mic" class="mic">üéôÔ∏è</div>
    </div>

    <!-- Speech Output -->
    <textarea id="output" placeholder="Your speech will appear here..."></textarea>

    <!-- Result -->
    <div id="result" class="output-box" style="display:none;">
        <h3>Extracted Details</h3>
        <p><strong>Business Name:</strong> <span id="biz"></span></p>
        <p><strong>Website Type:</strong> <span id="type"></span></p>
        <p><strong>Style:</strong> <span id="style"></span></p>
        <p><strong>Services:</strong> <span id="services"></span></p>

        <h3>Generated Website Preview</h3>
        <iframe id="preview"></iframe>
    </div>
</div>

<script>
    let recognition;
    let audioContext;
    let analyser;
    let animationId;
    let generatedFilePath = "";

    // üéôÔ∏è Start Recording
    async function startRecording() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Speech recognition not supported in this browser.");
            return;
        }

        const mic = document.getElementById("mic");
        const micBtn = document.getElementById("micBtn");

        micBtn.innerText = "Listening...";
        micBtn.disabled = true;

        mic.style.background = "#4CAF50";
        mic.style.color = "white";

        startMicVisualization();

        recognition = new webkitSpeechRecognition();
        recognition.lang = "en-US";
        recognition.continuous = false;

        recognition.onresult = (event) => {
            document.getElementById("output").value =
                event.results[0][0].transcript;
        };

        recognition.onend = stopMic;
        recognition.onerror = stopMic;

        recognition.start();
    }

    // üåä Voice Modulation
    async function startMicVisualization() {
        audioContext = new AudioContext();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;

        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        const mic = document.getElementById("mic");

        function animate() {
            analyser.getByteFrequencyData(dataArray);
            let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
            let scale = Math.min(40, volume);

            mic.style.boxShadow =
                `0 0 0 ${scale}px rgba(76,175,80,0.3)`;

            animationId = requestAnimationFrame(animate);
        }

        animate();
    }

    // üõë Stop Mic
    function stopMic() {
        const mic = document.getElementById("mic");
        const micBtn = document.getElementById("micBtn");

        micBtn.innerText = "Start Speaking";
        micBtn.disabled = false;

        cancelAnimationFrame(animationId);
        if (audioContext) audioContext.close();

        mic.style.boxShadow = "none";
        mic.style.background = "#e0e0e0";
        mic.style.color = "#555";
    }

    // üß† Generate Website
    async function generateWebsite() {
        const text = document.getElementById("output").value;

        if (!text.trim()) {
            alert("Please speak something first.");
            return;
        }

        const res = await fetch("/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
        });

        const data = await res.json();

        document.getElementById("biz").innerText = data.business_name;
        document.getElementById("type").innerText = data.website_type;
        document.getElementById("style").innerText = data.style;
        document.getElementById("services").innerText =
            data.services.join(", ");

        document.getElementById("preview").srcdoc = data.html;
        document.getElementById("result").style.display = "block";

        generatedFilePath = data.file_path;
    }

    // üì• Download HTML
    async function downloadHTML() {
        if (!generatedFilePath) {
            alert("Please generate the website first.");
            return;
        }

        const res = await fetch("/download-html", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ file_path: generatedFilePath })
        });

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "generated_website.html";
        a.click();
    }
</script>
</body>
</html>
